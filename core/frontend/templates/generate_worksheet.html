{% extends "base.html" %}
{% block title %}Generate Worksheet{% endblock %}
{% block content %}
<div class="max-w-2xl mx-auto bg-white p-6 rounded shadow">
    <h2 class="text-xl font-semibold mb-4">Generate a Worksheet</h2>
    <div id="content-wrapper" class="relative"></div>
        <form id="worksheet-form" class="space-y-4">
            <input type="text" name="title" placeholder="Title" class="w-full p-2 border rounded" required>
            <select id="subject" name="subject" placeholder="Subject"
              class="w-full p-2 border rounded" required>
              <!-- dynamically populated via AJAX -->
            </select>            
            <input type="number" name="grade" placeholder="Grade" class="w-full p-2 border rounded" required>
            <select id="worksheet_type" name="worksheet_type" placeholder="Worksheet Type"
              class="w-full p-2 border rounded" required>
              <!-- dynamically populated via AJAX -->
            </select>
            <button type="submit" class="bg-indigo-600 text-white px-4 py-2 rounded">Generate</button>
        </form>
        <!--  
        <div id="loader" class="hidden flex justify-center items-center mt-4">
            <div class="w-8 h-8 border-4 border-indigo-600 border-t-transparent rounded-full animate-spin"></div>
        </div>
        -->
        <div id="content" class="mt-6 hidden bg-gray-100 p-4 rounded"></div>

        <!-- Loading Overlay -->
        <div id="loading-overlay"
            class="absolute inset-0 bg-white bg-opacity-50 backdrop-blur-sm flex justify-center items-center z-10 hidden">
            <div class="w-15 h-15 border-4 border-indigo-600 border-t-transparent rounded-full animate-spin"></div>
        </div>
    </div>
</div>

<script>
  const subjectSelect = document.getElementById("subject");
  const worksheetTypeSelect = document.getElementById("worksheet_type");

  // Fetch schema for choices (drf-spectacular exposes choices in /schema/)
  fetch("/api/schema/?format=json")
    .then(response => response.json())
    .then(data => {
      try {
        const subjectChoices = data.components.schemas.SubjectEnum.enum;  // üéØ gets the actual enum list

        const option = document.createElement("option");
          option.value = "";
          option.textContent = "Select a Subject";
          subjectSelect.appendChild(option);

        subjectChoices.forEach(choice => {
          const option = document.createElement("option");
          option.value = choice;
          option.textContent = choice;
          subjectSelect.appendChild(option);
        });
      } catch (err) {
        console.error("Could not load subject choices from schema", err);
      }
      try {
        const worksheetTypeChoices = data.components.schemas.WorksheetTypeEnum.enum;  // üéØ gets the actual enum list

        const option = document.createElement("option");
          option.value = "";
          option.textContent = "Select a Worksheet Type";
          worksheetTypeSelect.appendChild(option);

        worksheetTypeChoices.forEach(choice => {
          const option = document.createElement("option");
          option.value = choice;
          option.textContent = choice;
          worksheetTypeSelect.appendChild(option);
        });
      } catch (err) {
        console.error("Could not load worksheet type choices from schema", err);
      }
    });

document.getElementById("worksheet-form").onsubmit = async function(e) {
  e.preventDefault();

  const overlay = document.getElementById("loading-overlay");
  const output = document.getElementById("content");
  const token = localStorage.getItem("access_token");

  // Show overlay and block interactions
  overlay.classList.remove("hidden");
  output.classList.add("hidden");

  console.log("Making a call now...")
  try {
    const res = await fetch("/api/worksheet/generate/", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "Authorization": `Bearer ${token}`
      },
      body: JSON.stringify({
        title: e.target.title.value,
        subject: e.target.subject.value,
        grade: e.target.grade.value,
        worksheet_type : e.target.worksheet_type.value,
        content: ""
      })
    });

    const data = await res.json();

    output.innerHTML = `
    <h3 class="text-lg font-semibold mb-2">Generated Worksheet:</h3>
    <pre class="whitespace-pre-wrap mb-4">${data.content || "No Worksheet generated.Limit Reached"}</pre>
    ${data.id ? `<a href="/worksheet/${data.id}/" class="text-indigo-600 hover:underline">‚û°Ô∏è View Full Story</a>` : ""}
    `;

  } catch (error) {
    output.innerHTML = `<p class="text-red-600">Something went wrong. Please try again.</p>`;
  }

  // Hide overlay and show result
  overlay.classList.add("hidden");
  output.classList.remove("hidden");
};
</script>

{% endblock %}
