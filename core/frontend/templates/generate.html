{% extends "base.html" %}
{% block title %}Generate Story{% endblock %}
{% block content %}
<div class="max-w-2xl mx-auto bg-white p-6 rounded shadow">
    <h2 class="text-xl font-semibold mb-4">Generate a Story</h2>
    <div id="content-wrapper" class="relative"></div>
        <form id="story-form" class="space-y-4">
            <input type="text" name="theme" placeholder="Theme" class="w-full p-2 border rounded" required>
            <input type="text" name="characters" placeholder="Characters" class="w-full p-2 border rounded" required>
            <input type="text" name="moral" placeholder="Moral" class="w-full p-2 border rounded" required>
            <button type="submit" class="bg-indigo-600 text-white px-4 py-2 rounded">Generate</button>
        </form>
        <!--  
        <div id="loader" class="hidden flex justify-center items-center mt-4">
            <div class="w-8 h-8 border-4 border-indigo-600 border-t-transparent rounded-full animate-spin"></div>
        </div>
        -->
        <div id="story-output" class="mt-6 hidden bg-gray-100 p-4 rounded"></div>

        <!-- Loading Overlay -->
        <div id="loading-overlay"
            class="absolute inset-0 bg-white bg-opacity-50 backdrop-blur-sm flex justify-center items-center z-10 hidden">
            <div class="w-10 h-10 border-4 border-indigo-600 border-t-transparent rounded-full animate-spin"></div>
        </div>
    </div>
</div>

<!--

<script>
document.getElementById("story-form").onsubmit = async function(e) {
  e.preventDefault();

  const loader = document.getElementById("loader");
  const token = localStorage.getItem("access_token");
  const output = document.getElementById("story-output");
  const overlay = document.getElementById("loading-overlay");


  // Show loader, hide output
  loader.classList.remove("hidden");
  output.classList.add("hidden");
  overlay.classList.remove("hidden");

  const res = await fetch("/api/generate/", {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "Authorization": `Bearer ${token}`
    },
    body: JSON.stringify({
      theme: e.target.theme.value,
      characters: e.target.characters.value,
      moral: e.target.moral.value
    })
  });
  const data = await res.json();

  // Hide loader, show output
  loader.classList.add("hidden");
  
  output.innerText = data.content || "No story generated.";
  output.classList.remove("hidden");
}
</script>
-->
<script>
document.getElementById("story-form").onsubmit = async function(e) {
  e.preventDefault();

  const overlay = document.getElementById("loading-overlay");
  const output = document.getElementById("story-output");
  const token = localStorage.getItem("access_token");

  // Show overlay and block interactions
  overlay.classList.remove("hidden");
  output.classList.add("hidden");

  try {
    const res = await fetch("/api/generate/", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "Authorization": `Bearer ${token}`
      },
      body: JSON.stringify({
        theme: e.target.theme.value,
        characters: e.target.characters.value,
        moral: e.target.moral.value
      })
    });

    const data = await res.json();

    output.innerHTML = `
    <h3 class="text-lg font-semibold mb-2">Generated Story:</h3>
    <pre class="whitespace-pre-wrap mb-4">${data.content || "No story generated."}</pre>
    ${data.id ? `<a href="/story/${data.id}/" class="text-indigo-600 hover:underline">➡️ View Full Story</a>` : ""}
    `;

  } catch (error) {
    output.innerHTML = `<p class="text-red-600">Something went wrong. Please try again.</p>`;
  }

  // Hide overlay and show result
  overlay.classList.add("hidden");
  output.classList.remove("hidden");
};
</script>

{% endblock %}
